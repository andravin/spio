import argparse

import torch
import ast

import spio


# Same as the pytorch-image-models function, but auto-generated by github copilot!
class ParseKwargs(argparse.Action):
    def __call__(self, parser, namespace, values, option_string=None):
        kw = {}
        for value in values:
            key, value = value.split("=")
            try:
                kw[key] = ast.literal_eval(value)
            except ValueError:
                kw[key] = str(
                    value
                )  # fallback to string (avoid need to escape on command line)
        setattr(namespace, self.dest, kw)


parser = argparse.ArgumentParser()
parser.add_argument("--kernel-class", type=str, default="ConvSmallGroupKernel")
parser.add_argument("--params", nargs="*", required=True, action=ParseKwargs)
parser.add_argument("--config", nargs="*", default={}, action=ParseKwargs)
parser.add_argument("--kernel-kwargs", nargs="*", default={}, action=ParseKwargs)
parser.add_argument("--auto-tune", action="store_true")
parser.add_argument("--warmup", type=int, default=100)
parser.add_argument("--num-iters", type=int, default=100)
parser.add_argument("--depth", type=int, default=1)
parser.add_argument("--benchmark-torch", action="store_true")
parser.add_argument("--skip-kernels", action="store_true")
args = parser.parse_args()

kernel_class = getattr(spio.kernels, args.kernel_class)
params = kernel_class.Params(**args.params)

if not args.skip_kernels:
    configs = None if args.auto_tune else [kernel_class.Config(**args.config)]

    first_inputs = params.random_inputs()
    outputs = first_inputs
    kernel_args_lst = []
    for d in range(args.depth):
        inputs = outputs
        outputs = (
            params.empty_outputs() if d < (args.depth - 1 or d == 0) else first_inputs
        )
        weights = params.random_weights()
        kernel_args = kernel_class.arrange_kernel_args(
            inputs=inputs, outputs=outputs, weights=weights
        )
        kernel_args_lst.append(kernel_args)

    spio.kernels.benchmark(
        kernel_class,
        params,
        kernel_args_lst,
        configs=configs,
        warmup=args.warmup,
        num_iters=args.num_iters,
        **args.kernel_kwargs
    )

if args.benchmark_torch:
    if not args.skip_kernels:
        print()
    torch_func = params.reference
    input = params.random_inputs()[0]
    torch_args_lst = [params.random_weights() for _ in range(args.depth)]
    spio.kernels.benchmark_reference(
        kernel_class,
        params,
        input,
        torch_args_lst,
        warmup=args.warmup,
        num_iters=args.num_iters,
    )
